var app=app||{};app.CmapView=Backbone.View.extend({el:"#treatment-cmap",events:{"click #instruction-read":"renderEditor","click #help":"renderInstructionModal","click #editor-button":"analyzeText","click #editor-full-button":"saveText"},initialize:function(){var e=this;this.prePageDurationStart=null,this.postPageDurationStart=null,this.colors=d3.scaleOrdinal(d3.schemeCategory10),this.simulations={},this.userModel=new app.UserSpecificModel,this.textModel=new app.TextModelComplete,this.analyzer=new app.TextAnalyzerModel,this.userModel.fetch({success:function(t,n){e.renderInstruction()},error:function(e,t){console.log(t)}})},renderInstruction:function(){this.$el.html(Handlebars.templates.instruction({instruction:this.userModel.get("instruction")}))},renderEditor:function(){this.prePageDurationStart=new Date,this.$el.html(Handlebars.templates.editor());var e=new MediumEditor("#editor-textinput",{toolbar:!1,placeholder:!1});$("#editor-textinput").html("<p>Schreibe hier ...</p>");var t=document.querySelector("#editor-textinput").firstChild;e.selectElement(t),this.$el.append('<i id="help" class="material-icons">help</i>'),this.$el.append(Handlebars.templates["modal-help"]({instruction:this.userModel.get("instruction")}))},renderInstructionModal:function(){$("#modal-help").openModal()},analyzeText:function(){var e=this;app.regExText("#editor-textinput");var t=app.getParagraphs(this.$el.find("#editor-textinput"));if(t.length<1e3)Materialize.toast("Ihr Text ist leider zu kurz.",4e3);else{var n=(new Date-this.prePageDurationStart)/1e3;this.postPageDurationStart=new Date,this.textModel.set({pre_page_duration:n,pre_text:t}),this.$el.find("#editor-button-div").html(Handlebars.templates["loading-ring"]()),this.analyzer.set({text:t}),this.analyzer.save(null,{success:function(t){e.renderRevision()},error:function(e,t){console.log(t.responseText)}})}},renderRevision:function(){this.$el.find("#editor-button-div").html('<a class="waves-effect waves-light btn" id="save-text">Text abschicken</a>'),this.textModel.set({pre_text:this.analyzer.get("text"),pre_num_sentences:this.analyzer.get("numSentences"),pre_num_clusters:this.analyzer.get("numCluster"),pre_num_coherent_sentences:this.analyzer.get("cohSentences"),pre_num_non_coherent_sentences:this.analyzer.get("cohNotSentences"),pre_num_concepts:this.analyzer.get("numConcepts"),pre_local_cohesion:this.analyzer.get("local cohesion")}),this.paragraphs=$("#editor-textinput").html(),this.$el.html(Handlebars.templates["editor-full"]({instruction:app.constants.simpleRevisionModal})),this.$el.append('<i id="help" class="material-icons">help</i>'),this.$el.append(Handlebars.templates["modal-help"]({instruction:this.userModel.get("instructionreview")})),$("#editor-full-medium-editor").html(this.paragraphs);new MediumEditor("#editor-full-medium-editor",{toolbar:!1});$("#editor-full-button").text("Text abschicken"),this.$el.append(Handlebars.templates["modal-revision"]({instruction:this.userModel.get("instructionreview")})),$("#modal-revision").openModal();var e=$("#editor-full-graph").width(),t=$("#editor-full-medium-editor").height();this.renderCmap(this.analyzer.get("word_pairs"),this.analyzer.get("clusters"),this.analyzer.get("numClusters"),"#editor-full-graph",t,e,this.colors)},renderCmap:function(e,t,n,r,i,s,a){function o(e,t){function n(e){var t=(d3.mouse(this),g.select("#node-"+e.id)),n=t.data()[0];t.select("text").style("opacity",1).style("font-weight","bold");f.selectAll("text").style("opacity",function(e){return i(n,e)?1:.1}),f.selectAll("circle").style("fill",function(e){return i(n,e)?"#000":"#f4f4f4"}).style("opacity",function(e){return i(n,e)?1:.2}),f.selectAll("line").style("stroke",function(e){return e.source.id===n.id||e.target.id===n.id?"#4c4c4c":"#f4f4f4"})}function i(e,t){return a(e,t)||s(e,t)||e.index==t.index}function s(e,t){return x[e.index+","+t.index]}function a(e,t){return x[t.index+","+e.index]}function o(){g.attr("transform",d3.event.transform)}var p=e,h=app.getLinksNodes(p),f=d3.select(r).append("svg"),m=d3.forceSimulation(h.nodes).force("charge",d3.forceManyBody().strength(-240)).force("link",d3.forceLink(h.links).distance(200).id(function(e){return e.id})).force("center",d3.forceCenter(u/2,d/2)).force("x",d3.forceX()).force("y",d3.forceY()).stop(),g=f.append("g"),x={};f.call(d3.zoom().scaleExtent([.1,10]).on("zoom",o));var y=f.append("text").attr("dy","0.35em").attr("text-anchor","middle").attr("font-family","sans-serif").attr("font-size",10).attr("x",u/2).attr("y",d/2).text("Simulating. One moment pleaseâ€¦");d3.timeout(function(){y.remove();for(var e=0,r=Math.ceil(Math.log(m.alphaMin())/Math.log(1-m.alphaDecay()));r>e;++e)m.tick();var i=g.append("g").attr("class","links").selectAll("line").data(h.links).enter().append("line").attr("x1",function(e){return e.source.x}).attr("y1",function(e){return e.source.y}).attr("x2",function(e){return e.target.x}).attr("y2",function(e){return e.target.y});i.each(function(e){x[e.source.index+","+e.target.index]=!0}),c.simulations[t]={simulation:m,linkedByIndex:x,svg:f};var s=g.append("g").attr("class","nodes").selectAll(".node").data(h.nodes).enter().append("g").attr("id",function(e,t){return"node-"+e.id}).attr("class","node").attr("transform",function(e){return"translate("+e.x+","+e.y+")"}).on("mouseover",n).on("mouseout",l);s.append("circle").attr("r",10).attr("cx",0).attr("cy",0).attr("fill","#ccc"),s.append("text").attr("dy",-10).attr("dx",12).style("opacity",.8).attr("text-anchor","start").text(function(e){return e.id})})}function l(){$("#editor-full-medium-editor").find("p").each(function(e){var t=$(this).text(),n=t.replace(/([A-z0-9'<>\u00dc\u00fc\u00e4\u00c4\u00f6\u00d6\u00df\-\/]+)/g,"<span>$1</span>"),r=$(n);$(this).html(r)});var e=d3.selectAll(".node");e.selectAll("text").style("opacity",.8).style("font-weight","normal"),d3.selectAll("circle").style("fill","#ccc").style("opacity",1),d3.selectAll(".links").selectAll("line").style("stroke","#ccc")}for(var c=this,d=i/2,u=s/2,p=this.analyzer.get("clusters"),h=0;h<p.length;h++)o(p[h],h)},saveText:function(){var e=this,t=(new Date-this.postPageDurationStart)/1e3;this.$el.find("#editor-full-button-div").html(Handlebars.templates["loading-ring"]());var n=app.getParagraphs(this.$el.find("#editor-full-medium-editor"));this.textModel.set({post_text:n,post_page_duration:t}),this.analyzer.set({text:n}),this.analyzer.save(null,{success:function(t){e.sendToServer()},error:function(e,t){console.log(t.responseText)}})},sendToServer:function(){this.textModel.set({post_num_sentences:this.analyzer.get("numSentences"),post_num_clusters:this.analyzer.get("numCluster"),post_num_coherent_sentences:this.analyzer.get("cohSentences"),post_num_non_coherent_sentences:this.analyzer.get("cohNotSentences"),post_num_concepts:this.analyzer.get("numConcepts"),post_local_cohesion:this.analyzer.get("local cohesion")}),this.textModel.save(null,{success:function(e){location.reload()},error:function(e,t){console.log("error")}})}}),new app.CmapView;
//# sourceMappingURL=cmap.js.map
