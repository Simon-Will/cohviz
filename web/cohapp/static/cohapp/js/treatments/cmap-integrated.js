var app=app||{};app.CmapView=Backbone.View.extend({el:"#treatment-cmap-integrated",events:{"click #instruction-read":"renderEditor","click #help":"renderInstructionModal","click #editor-button":"analyzeText","click #editor-full-button":"saveText"},initialize:function(){var e=this;this.prePageDurationStart=null,this.postPageDurationStart=null,this.colors=d3.scaleOrdinal(d3.schemeCategory10),this.userModel=new app.UserSpecificModel,this.textModel=new app.TextModelComplete,this.analyzer=new app.TextAnalyzerModel,this.userModel.fetch({success:function(t,n){e.renderInstruction()},error:function(e,t){console.log(t)}})},renderInstruction:function(){this.$el.html(Handlebars.templates.instruction({instruction:this.userModel.get("instruction")}))},renderEditor:function(){this.prePageDurationStart=new Date,this.$el.html(Handlebars.templates.editor());var e=new MediumEditor("#editor-textinput",{toolbar:!1,placeholder:!1});$("#editor-textinput").html("<p>Schreibe hier ...</p>");var t=document.querySelector("#editor-textinput").firstChild;e.selectElement(t),this.$el.append('<i id="help" class="material-icons">help</i>'),this.$el.append(Handlebars.templates["modal-help"]({instruction:this.userModel.get("instruction")}))},renderInstructionModal:function(){$("#modal-help").openModal()},analyzeText:function(){var e=this;app.regExText("#editor-textinput");var t=app.getParagraphs(this.$el.find("#editor-textinput"));if(t.length<1e3)Materialize.toast("Ihr Text ist leider zu kurz.",4e3);else{var n=(new Date-this.prePageDurationStart)/1e3;this.postPageDurationStart=new Date,this.textModel.set({pre_page_duration:n,pre_text:t}),this.$el.find("#editor-button-div").html(Handlebars.templates["loading-ring"]()),this.analyzer.set({text:t}),this.analyzer.save(null,{success:function(t){e.renderRevision()},error:function(e,t){console.log(t.responseText)}})}},renderRevision:function(){this.$el.find("#editor-button-div").html('<a class="waves-effect waves-light btn" id="save-text">Text abschicken</a>'),this.textModel.set({pre_text:this.analyzer.get("text"),pre_num_sentences:this.analyzer.get("numSentences"),pre_num_clusters:this.analyzer.get("numClusters"),pre_num_coherent_sentences:this.analyzer.get("cohSentences"),pre_num_non_coherent_sentences:this.analyzer.get("cohNotSentences"),pre_num_concepts:this.analyzer.get("numConcepts")}),this.paragraphs=$("#editor-textinput").html(),this.$el.html(Handlebars.templates["editor-full"]({instruction:app.constants.simpleRevisionModal})),this.$el.append('<i id="help" class="material-icons">help</i>'),this.$el.append(Handlebars.templates["modal-help"]({instruction:this.userModel.get("instructionreview")})),$("#editor-full-medium-editor").html(this.paragraphs);new MediumEditor("#editor-full-medium-editor",{toolbar:!1});$("#editor-full-button").text("Text abschicken"),this.$el.append(Handlebars.templates["modal-help"]({instruction:this.userModel.get("instructionreview")})),$("#modal-help").openModal();var e=$("#editor-full-graph").width(),t=$("#editor-full-medium-editor").height();this.renderCmap(this.analyzer.get("word_pairs"),this.analyzer.get("clusters"),this.analyzer.get("numClusters"),"#editor-full-graph",t,e,this.colors)},saveText:function(){var e=this,t=(new Date-this.postPageDurationStart)/1e3;this.$el.find("#editor-full-button-div").html(Handlebars.templates["loading-ring"]());var n=app.getParagraphs(this.$el.find("#editor-full-medium-editor"));n=n.replace(/\s\,/g,","),n=n.replace(/\s\./g,"."),n=n.replace(/\s!/g,"!"),n=n.replace(/\[\s/g,"["),n=n.replace(/\s&/g,"&"),n=n.replace(/\s`/g,"`"),n=n.replace(/\s~/g,"~"),n=n.replace(/\s;/g,";"),n=n.replace(/\s_/g,"_"),n=n.replace(/\s]/g,"]"),n=n.replace(/\s:/g,":"),n=n.replace(/\s\?/g,"?"),n=n.replace(/\(\s/g,"("),n=n.replace(/\s\)/g,")"),n=n.replace(/\s\//g,"/"),this.textModel.set({post_text:n,post_page_duration:t}),this.analyzer.set({text:n}),this.analyzer.save(null,{success:function(t){e.sendToServer()},error:function(e,t){console.log(t.responseText)}})},sendToServer:function(){this.textModel.set({post_num_sentences:this.analyzer.get("numSentences"),post_num_clusters:this.analyzer.get("numClusters"),post_num_coherent_sentences:this.analyzer.get("cohSentences"),post_num_non_coherent_sentences:this.analyzer.get("cohNotSentences"),post_num_concepts:this.analyzer.get("numConcepts")}),this.textModel.save(null,{success:function(e){location.reload()},error:function(e,t){console.log("error")}})},renderCmap:function(e,t,n,r,i,l,s){function a(){S.attr("transform",d3.event.transform)}function o(){T.attr("x1",function(e){return e.source.x}).attr("y1",function(e){return e.source.y}).attr("x2",function(e){return e.target.x}).attr("y2",function(e){return e.target.y}),A.attr("transform",function(e){return"translate("+e.x+","+e.y+")"})}function c(e){d3.event.active||k.alphaTarget(.3).restart(),e.fx=e.x,e.fy=e.y}function d(e){e.fx=d3.event.x,e.fy=d3.event.y}function u(e){d3.event.active||k.alphaTarget(0),e.fx=null,e.fy=null}function p(){$("#editor-full-medium-editor").find("p").each(function(e){var t=$(this).text();$(this).html(t)});var e=d3.selectAll(".node");e.selectAll("circle").style("opacity",.6).attr("r",15),e.selectAll("text").style("opacity",0),d3.selectAll(".links").selectAll("line").style("stroke","#ccc")}function h(){var e=d3.mouse(this),t=k.find(e[0],e[1]),n=d3.selectAll(".node").filter(function(e){return e.id==t.id}),r=n.select("text").style("opacity",1).style("font-size",20).style("font-weight","bold");n.select("circle").attr("r",25),A.selectAll("circle").style("opacity",function(e){return f(t,e)?1:.6}),A.selectAll("text").style("opacity",function(e){return f(t,e)?1:0}),T.style("stroke",function(e){return e.source.id===t.id||e.target.id===t.id?"#000":"#ccc"});var i=d3.selectAll(".node").filter(function(e){return e.id!=t.id});i.select("text").style("font-size",16).style("font-weight","normal"),i.select("circle").attr("r",15);var l=r.text(),s=[];A.selectAll("text").each(function(e){f(t,e)&&s.push(e.id)});var a=s.indexOf(l);s.splice(a,1),app.highlightSelectedWord("#editor-full-medium-editor",l,s,v,y,x.colors)}function f(e,t){return m(e,t)||g(e,t)||e.index==t.index}function g(e,t){return C[e.index+","+t.index]}function m(e,t){return C[t.index+","+e.index]}var x=this,y=t,v=this.analyzer.get("lemmaDic"),_=app.getLinksNodes(e),z=i,w=l,b=($(window).height(),{top:0,right:0,bottom:0,left:0}),M=d3.select(r).append("svg").attr("width",w+b.left+b.right).attr("height",z+b.top+b.bottom),k=(M.append("rect").attr("width",w).attr("height",z).style("fill","none").style("pointer-events","all"),d3.forceSimulation().force("link",d3.forceLink().id(function(e){return e.id})).force("charge",d3.forceManyBody().strength(50)).force("center",d3.forceCenter(w/2,z/2)).force("collide",d3.forceCollide(40).iterations(60)));M.call(d3.zoom().scaleExtent([.1,10]).on("zoom",a));var S=M.append("g").on("mouseover",h).on("mouseout",p),T=S.append("g").attr("class","links").selectAll("line").data(_.links).enter().append("line"),A=S.append("g").attr("class","nodes").selectAll(".node").data(_.nodes).enter().append("g").attr("class","node").call(d3.drag().on("start",c).on("drag",d).on("end",u));A.append("circle").attr("r",15).attr("cx",0).attr("cy",0).style("fill",function(e){for(var t=0;t<y.length;t++)if(-1!=$.inArray(e.id,y[t]))return s(t)}).style("opacity",.6),A.append("text").attr("dy","-.35em").attr("dx","1.4em").text(function(e){return e.id});k.nodes(_.nodes).on("tick",o),k.force("link").links(_.links);var C={};T.each(function(e){C[e.source.index+","+e.target.index]=!0})}}),new app.CmapView;
//# sourceMappingURL=cmap-integrated.js.map
